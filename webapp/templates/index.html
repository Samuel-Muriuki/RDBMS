<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleDB - Task Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="background-gradient"></div>
    
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1 class="title">
                    <span class="title-icon">üóÑÔ∏è</span>
                    SimpleDB Task Manager
                </h1>
                <p class="subtitle">Powered by a custom-built RDBMS</p>
            </div>
        </header>

        <main class="main-content">
            <!-- Task Creation Form -->
            <section class="card form-card">
                <h2 class="card-title">Create New Task</h2>
                <form id="taskForm" class="task-form">
                    <div class="form-group">
                        <label for="taskTitle">Title</label>
                        <input type="text" id="taskTitle" placeholder="Enter task title..." required>
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">Description</label>
                        <textarea id="taskDescription" placeholder="Enter task description..." rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="taskStatus">Status</label>
                        <select id="taskStatus">
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">‚ûï</span>
                        Add Task
                    </button>
                </form>
            </section>

            <!-- Task List -->
            <section class="card tasks-card">
                <h2 class="card-title">Tasks</h2>
                <div id="tasksList" class="tasks-list">
                    <div class="loading">Loading tasks...</div>
                </div>
            </section>

            <!-- SQL Console -->
            <section class="card console-card">
                <h2 class="card-title">SQL Console</h2>
                <form id="sqlForm" class="sql-form">
                    <div class="form-group">
                        <label for="sqlQuery">Execute SQL Query</label>
                        <textarea id="sqlQuery" placeholder="SELECT * FROM tasks;" rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-secondary">
                        <span class="btn-icon">‚ñ∂Ô∏è</span>
                        Execute
                    </button>
                </form>
                <div id="sqlResult" class="sql-result"></div>
            </section>
        </main>
    </div>

    <script>
        // API base URL
        const API_BASE = '/api';

        // Load tasks on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTasks();
        });

        // Task form submission
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const status = document.getElementById('taskStatus').value;

            try {
                const response = await fetch(`${API_BASE}/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description, status })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear form
                    document.getElementById('taskForm').reset();
                    // Reload tasks
                    loadTasks();
                    showNotification('Task created successfully!', 'success');
                } else {
                    showNotification(result.error || 'Failed to create task', 'error');
                }
            } catch (error) {
                showNotification('Network error', 'error');
            }
        });

        // SQL form submission
        document.getElementById('sqlForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const sql = document.getElementById('sqlQuery').value;
            const resultDiv = document.getElementById('sqlResult');

            try {
                const response = await fetch(`${API_BASE}/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql })
                });

                const result = await response.json();
                
                if (result.success) {
                    if (result.rows) {
                        // SELECT query - show table
                        resultDiv.innerHTML = formatTable(result.columns, result.rows);
                    } else {
                        // Other query - show message
                        resultDiv.innerHTML = `<div class="success-message">${result.message}</div>`;
                    }
                    loadTasks(); // Reload tasks in case they changed
                } else {
                    resultDiv.innerHTML = `<div class="error-message">${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error-message">Network error</div>`;
            }
        });

        // Load tasks from API
        async function loadTasks() {
            const tasksList = document.getElementById('tasksList');
            
            try {
                const response = await fetch(`${API_BASE}/tasks`);
                const result = await response.json();

                if (result.success && result.tasks.length > 0) {
                    tasksList.innerHTML = result.tasks.map(task => createTaskCard(task)).join('');
                } else {
                    tasksList.innerHTML = '<div class="empty-state">No tasks yet. Create one above!</div>';
                }
            } catch (error) {
                tasksList.innerHTML = '<div class="error-message">Failed to load tasks</div>';
            }
        }

        // Create task card HTML
        function createTaskCard(task) {
            const statusClass = task.status.replace('-', '');
            const statusEmoji = {
                'pending': '‚è≥',
                'in-progress': 'üîÑ',
                'completed': '‚úÖ'
            }[task.status] || 'üìù';

            return `
                <div class="task-item" data-id="${task.id}">
                    <div class="task-header">
                        <h3 class="task-title">${escapeHtml(task.title)}</h3>
                        <span class="task-status status-${statusClass}">
                            ${statusEmoji} ${task.status}
                        </span>
                    </div>
                    <p class="task-description">${escapeHtml(task.description || 'No description')}</p>
                    <div class="task-footer">
                        <span class="task-date">Created: ${task.created_at}</span>
                        <div class="task-actions">
                            <button onclick="updateTaskStatus(${task.id}, '${task.status}')" class="btn-icon-small" title="Change status">
                                üîÑ
                            </button>
                            <button onclick="deleteTask(${task.id})" class="btn-icon-small" title="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update task status
        async function updateTaskStatus(id, currentStatus) {
            const statuses = ['pending', 'in-progress', 'completed'];
            const currentIndex = statuses.indexOf(currentStatus);
            const newStatus = statuses[(currentIndex + 1) % statuses.length];

            try {
                const response = await fetch(`${API_BASE}/tasks/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();

                if (result.success) {
                    loadTasks();
                    showNotification('Task updated!', 'success');
                } else {
                    showNotification(result.error || 'Failed to update task', 'error');
                }
            } catch (error) {
                showNotification('Network error', 'error');
            }
        }

        // Delete task
        async function deleteTask(id) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tasks/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    loadTasks();
                    showNotification('Task deleted!', 'success');
                } else {
                    showNotification(result.error || 'Failed to delete task', 'error');
                }
            } catch (error) {
                showNotification('Network error', 'error');
            }
        }

        // Format table for SQL results
        function formatTable(columns, rows) {
            if (!rows || rows.length === 0) {
                return '<div class="empty-state">No results</div>';
            }

            let html = '<div class="sql-table-wrapper"><table class="sql-table">';
            
            // Header
            html += '<thead><tr>';
            columns.forEach(col => {
                html += `<th>${escapeHtml(col)}</th>`;
            });
            html += '</tr></thead>';
            
            // Rows
            html += '<tbody>';
            rows.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    const value = row[col] === null ? 'NULL' : row[col];
                    html += `<td>${escapeHtml(String(value))}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            html += `<div class="result-count">${rows.length} row(s) returned</div>`;
            
            return html;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
