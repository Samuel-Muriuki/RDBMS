<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleDB - Task Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icon.png') }}">
</head>
<body>
    <div class="background-gradient"></div>
    
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="header-main">
                    <h1 class="title">
                        <img src="{{ url_for('static', filename='icon.png') }}" alt="SimpleDB Logo" class="header-logo">
                        SimpleDB Task Manager
                    </h1>
                    <div class="theme-toggle">
                        <button id="themeToggleBtn" class="btn-icon-small" title="Toggle Theme">
                            <span id="themeIcon">üåì</span>
                        </button>
                    </div>
                </div>
                <p class="subtitle">Powered by a custom-built RDBMS</p>
            </div>
        </header>

        <main class="main-content">
            <!-- Task Creation Form -->
            <section class="card form-card">
                <h2 class="card-title">Create New Task</h2>
                <form id="taskForm" class="task-form">
                    <div class="form-group">
                        <label for="taskTitle">Title</label>
                        <input type="text" id="taskTitle" placeholder="Enter task title..." required>
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">Description</label>
                        <textarea id="taskDescription" placeholder="Enter task description..." rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="taskCategory">Category</label>
                        <select id="taskCategory">
                            <option value="1">Work</option>
                            <option value="2">Personal</option>
                            <option value="3">Urgent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskStatus">Status</label>
                        <select id="taskStatus">
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">‚ûï</span>
                        Add Task
                    </button>
                </form>
            </section>

            <!-- Task List -->
            <section class="card tasks-card">
                <h2 class="card-title">Tasks</h2>
                <div id="tasksList" class="tasks-list">
                    <div class="loading">Loading tasks...</div>
                </div>
            </section>

            <!-- SQL Console -->
            <section class="card console-card">
                <h2 class="card-title">SQL Console</h2>
                <div class="sample-queries">
                    <label style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem; display: block;">Sample Queries:</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <button type="button" onclick="setSampleQuery('SELECT * FROM tasks;')" class="btn-sample">
                            üìã View All Tasks
                        </button>
                        <button type="button" onclick="setSampleQuery('SELECT * FROM tasks WHERE status = \'pending\';')" class="btn-sample">
                            ‚è≥ Pending Tasks
                        </button>
                        <button type="button" onclick="setSampleQuery('SELECT title, status FROM tasks ORDER BY id DESC;')" class="btn-sample">
                            üîΩ Recent Tasks
                        </button>
                        <button type="button" onclick="setSampleQuery('SELECT COUNT(*) as total FROM tasks;')" class="btn-sample">
                            üî¢ Count Tasks
                        </button>
                        <button type="button" onclick="setSampleQuery('DELETE FROM tasks WHERE status = \'completed\';')" class="btn-sample">
                            üóëÔ∏è Delete Completed
                        </button>
                        <button type="button" onclick="setSampleQuery('SELECT tasks.title, categories.name as category FROM tasks JOIN categories ON tasks.category_id = categories.id;')" class="btn-sample">
                            üîó JOIN Tasks & Categories
                        </button>
                    </div>
                </div>
                <form id="sqlForm" class="sql-form">
                    <div class="form-group">
                        <label for="sqlQuery">Execute SQL Query</label>
                        <textarea id="sqlQuery" placeholder="SELECT * FROM tasks;" rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-secondary">
                        <span class="btn-icon">‚ñ∂Ô∏è</span>
                        Execute
                    </button>
                </form>
                <div id="sqlResult" class="sql-result"></div>
            </section>
            <!-- RDBMS Learning Hub -->
            <section class="card learning-card">
                <h2 class="card-title">RDBMS Learning Hub</h2>
                <div class="learning-content">
                    <div class="learning-milestones">
                        <button class="milestone-badge" id="m-start" onclick="showArticle('intro')" title="First step into RDBMS">üéì Explorer</button>
                        <button class="milestone-badge locked" id="m-crud" onclick="showArticle('crud')" title="Perform a CRUD operation">üõ†Ô∏è Builder</button>
                        <button class="milestone-badge locked" id="m-sql" onclick="showArticle('acid')" title="Learn about ACID properties">üìú Scribe</button>
                        <button class="milestone-badge locked" id="m-join" onclick="showArticle('relational')" title="Join multiple tables">üîó Weaver</button>
                    </div>
                    
                    <div class="article-viewer">
                        <div class="article-tabs">
                            <button class="article-tab" id="tab-intro" onclick="showArticle('intro')">Intro</button>
                            <button class="article-tab" id="tab-crud" onclick="showArticle('crud')">CRUD</button>
                            <button class="article-tab" id="tab-acid" onclick="showArticle('acid')">ACID</button>
                            <button class="article-tab" id="tab-relational" onclick="showArticle('relational')">Relational</button>
                        </div>
                        <div id="articleContent" class="article-body">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Edit Task Modal -->
    <div id="editTaskModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Task</h2>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId">
                <div class="form-group">
                    <label for="editTaskTitle">Title</label>
                    <input type="text" id="editTaskTitle" required>
                </div>
                <div class="form-group">
                    <label for="editTaskDescription">Description</label>
                    <textarea id="editTaskDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editTaskCategory">Category</label>
                    <select id="editTaskCategory">
                        <option value="1">Work</option>
                        <option value="2">Personal</option>
                        <option value="3">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editTaskStatus">Status</label>
                    <select id="editTaskStatus">
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" style="background: rgba(148, 163, 184, 0.1); color: var(--text-primary);" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // API base URL
        const API_BASE = '/api';

        // Theme Handling
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const themeIcon = document.getElementById('themeIcon');
        
        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'system';
        applyTheme(savedTheme);

        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        });

        function applyTheme(theme) {
            if (theme === 'system') {
                const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', systemDark ? 'dark' : 'light');
                themeIcon.textContent = 'üåì';
            } else {
                document.documentElement.setAttribute('data-theme', theme);
                themeIcon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            }
            localStorage.setItem('theme', theme);
        }

        // Global state to track tasks change
        let lastTasksJson = '';

        // Load tasks on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTasks(true); // Initial load with loader
            // Start real-time sync (polling)
            setInterval(loadTasks, 5000); // Sync every 5 seconds
        });

        // Task form submission
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const status = document.getElementById('taskStatus').value;
            const category_id = document.getElementById('taskCategory').value;

            try {
                const response = await fetch(`${API_BASE}/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description, status, category_id })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear form
                    document.getElementById('taskForm').reset();
                    // Reload tasks
                    loadTasks();
                    showNotification('Task created successfully!', 'success');
                    unlockMilestone('m-crud', 'Task Master: Your first CRUD operation!');
                } else {
                    showNotification(result.error || 'Failed to create task', 'error');
                }
            } catch (error) {
                showNotification('Network error', 'error');
            }
        });

        // SQL form submission
        document.getElementById('sqlForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const sql = document.getElementById('sqlQuery').value;
            const resultDiv = document.getElementById('sqlResult');

            try {
                const response = await fetch(`${API_BASE}/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql })
                });

                const result = await response.json();
                
                if (result.success) {
                    if (result.rows) {
                        // SELECT query - show table
                        resultDiv.innerHTML = formatTable(result.columns, result.rows);
                        unlockMilestone('m-sql', 'Scribe: Executed your first custom SQL query!');
                        
                        // Check for JOIN in query
                        if (sql.toUpperCase().includes('JOIN')) {
                            unlockMilestone('m-join', 'Weaver: Mastered relational connections with a JOIN!');
                        }
                    } else {
                        // Other query - show message
                        resultDiv.innerHTML = `<div class="success-message">${result.message}</div>`;
                    }
                    loadTasks(); // Reload tasks in case they changed
                } else {
                    resultDiv.innerHTML = `<div class="error-message">${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error-message">Network error</div>`;
            }
        });

        // Load tasks from API
        async function loadTasks(force = false) {
            const tasksList = document.getElementById('tasksList');
            
            try {
                const response = await fetch(`${API_BASE}/tasks`);
                const result = await response.json();

                if (result.success) {
                    const currentJson = JSON.stringify(result.tasks);
                    
                    // Only update DOM if data has changed
                    if (currentJson === lastTasksJson && !force) {
                        return;
                    }
                    
                    lastTasksJson = currentJson;
                    
                    if (result.tasks.length > 0) {
                        // Surgical update would be better, but for this scale, 
                        // just avoiding the flinch on identical data is key.
                        // We use a temporary container to avoid layout thrashing.
                        const fragment = document.createDocumentFragment();
                        result.tasks.forEach(task => {
                            const div = document.createElement('div');
                            div.innerHTML = createTaskCard(task);
                            fragment.appendChild(div.firstElementChild);
                        });
                        
                        tasksList.innerHTML = '';
                        tasksList.appendChild(fragment);
                    } else {
                        tasksList.innerHTML = '<div class="empty-state">No tasks yet. Create one now!</div>';
                    }
                } else {
                    tasksList.innerHTML = `<div class="error-message">${result.error || 'Failed to load tasks'}</div>`;
                }
            } catch (error) {
                console.error('Refetch error:', error);
                // Don't show error message if we already have tasks showing
                if (tasksList.children.length === 0 || tasksList.querySelector('.loading')) {
                    tasksList.innerHTML = '<div class="error-message">Failed to load tasks</div>';
                }
            }
        }

        // Create task card HTML
        function createTaskCard(task) {
            const statusClass = task.status.replace('-', '');
            const statusEmoji = {
                'pending': '‚è≥',
                'in-progress': 'üîÑ',
                'completed': '‚úÖ'
            }[task.status] || 'üìù';

            // Category badge mapping
            const catMap = {1: 'üíº Work', 2: 'üë§ Personal', 3: 'üö® Urgent'};
            const catName = catMap[task.category_id] || 'üìÅ General';

            return `
                <div class="task-item" data-id="${task.id}">
                    <div class="task-header">
                        <div class="title-group">
                            <h3 class="task-title">${escapeHtml(task.title)}</h3>
                            <span class="task-category-label">${catName}</span>
                        </div>
                        <span class="task-status status-${statusClass}">
                            ${statusEmoji} ${task.status}
                        </span>
                    </div>
                    <p class="task-description">${escapeHtml(task.description || 'No description')}</p>
                    <div class="task-footer">
                        <span class="task-date">Created: ${task.created_at}</span>
                        <div class="task-actions">
                            <button onclick='openEditModal(${JSON.stringify(task).replace(/'/g, "&apos;")})' class="btn-icon-small" title="Edit Task">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="deleteTask(${task.id})" class="btn-icon-small" title="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Modal triggers
        function openEditModal(task) {
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskTitle').value = task.title;
            document.getElementById('editTaskDescription').value = task.description || '';
            document.getElementById('editTaskCategory').value = task.category_id;
            document.getElementById('editTaskStatus').value = task.status;
            
            const modal = document.getElementById('editTaskModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeEditModal() {
            const modal = document.getElementById('editTaskModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // Edit form submission
        document.getElementById('editTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editTaskId').value;
            const payload = {
                title: document.getElementById('editTaskTitle').value,
                description: document.getElementById('editTaskDescription').value,
                category_id: document.getElementById('editTaskCategory').value,
                status: document.getElementById('editTaskStatus').value
            };

            try {
                const response = await fetch(`${API_BASE}/tasks/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.success) {
                    closeEditModal();
                    loadTasks(true);
                    showNotification('Task updated successfully!', 'success');
                } else {
                    showNotification(result.error || 'Update failed', 'error');
                }
            } catch (error) {
                showNotification('Network error', 'error');
            }
        });


        // Delete task
        async function deleteTask(id) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tasks/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    loadTasks();
                    showNotification('Task deleted!', 'success');
                } else {
                    showNotification(result.error || 'Failed to delete task', 'error');
                }
            } catch (error) {
                showNotification('Network error', 'error');
            }
        }

        // Format table for SQL results
        function formatTable(columns, rows) {
            if (!rows || rows.length === 0) {
                return '<div class="empty-state">No results</div>';
            }

            let html = '<div class="sql-table-wrapper"><table class="sql-table">';
            
            // Header
            html += '<thead><tr>';
            columns.forEach(col => {
                html += `<th>${escapeHtml(col)}</th>`;
            });
            html += '</tr></thead>';
            
            // Rows
            html += '<tbody>';
            rows.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    const value = row[col] === null ? 'NULL' : row[col];
                    html += `<td>${escapeHtml(String(value))}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            html += `<div class="result-count">${rows.length} row(s) returned</div>`;
            
            return html;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Learning Hub Content
        const articles = {
            'intro': `
                <h3>What is an RDBMS?</h3>
                <p>A Relational Database Management System (RDBMS) is software that manages databases where data is organized into tables linked by relationships.</p>
                <p>Key building blocks:</p>
                <ul>
                    <li><strong>Table:</strong> Where data lives (Rows and Columns)</li>
                    <li><strong>Primary Key:</strong> Unique ID for each row</li>
                    <li><strong>Foreign Key:</strong> Links one table to another</li>
                </ul>
            `,
            'crud': `
                <h3>CRUD Operations</h3>
                <p>CRUD stands for Create, Read, Update, and Delete‚Äîthe four basic functions of persistent storage.</p>
                <ul>
                    <li><strong>Create:</strong> INSERT INTO table ...</li>
                    <li><strong>Read:</strong> SELECT * FROM table ...</li>
                    <li><strong>Update:</strong> UPDATE table SET ...</li>
                    <li><strong>Delete:</strong> DELETE FROM table ...</li>
                </ul>
                <p>In SimpleDB, you can perform these via the form or the SQL console!</p>
            `,
            'acid': `
                <h3>ACID Properties</h3>
                <p>Reliability in RDBMS is guaranteed by ACID:</p>
                <ul>
                    <li><strong>Atomicity:</strong> All or nothing transactions</li>
                    <li><strong>Consistency:</strong> Valid rules only</li>
                    <li><strong>Isolation:</strong> Concurrent transactions don't clash</li>
                    <li><strong>Durability:</strong> Data persists after crashes</li>
                </ul>
            `,
            'relational': `
                <h3>The Relational Model & JOINs</h3>
                <p>The core power of an RDBMS is joining data. Instead of duplicating info, we link tables using common values.</p>
                <p><strong>Example:</strong> Connecting a Task to its Category via <code>category_id</code>.</p>
                <p>Try the "JOIN Tasks & Categories" sample query to see it in action!</p>
            `
        };

        function showArticle(id) {
            const milestoneMap = {
                'intro': 'm-start',
                'crud': 'm-crud',
                'acid': 'm-sql',
                'relational': 'm-join'
            };
            
            const badgeId = milestoneMap[id];
            const badge = document.getElementById(badgeId);
            
            // Prevent switching if the milestone is locked (except for intro)
            if (id !== 'intro' && badge && badge.classList.contains('locked')) {
                showNotification('üîí This milestone is locked! Perform the required action to unlock it.', 'info');
                return;
            }

            if (!articles[id]) return;
            document.getElementById('articleContent').innerHTML = articles[id];
            
            // Update Milestone badges
            document.querySelectorAll('.milestone-badge').forEach(b => {
                b.classList.remove('active');
                if (b.id === badgeId) b.classList.add('active');
            });
            
            // Update Inner tabs
            document.querySelectorAll('.article-tab').forEach(tab => {
                const tabId = tab.getAttribute('onclick').match(/'([^']+)'/)[1];
                if (tabId === id) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
        }

        // Initialize first article and sync locks
        document.addEventListener('DOMContentLoaded', () => {
            syncTabLocks();
            showArticle('intro');
        });

        // Sync tab locked states from milestones
        function syncTabLocks() {
            const map = {
                'tab-intro': 'm-start',
                'tab-crud': 'm-crud',
                'tab-acid': 'm-sql',
                'tab-relational': 'm-join'
            };
            Object.entries(map).forEach(([tabId, badgeId]) => {
                const badge = document.getElementById(badgeId);
                const tab = document.getElementById(tabId);
                if (badge && tab) {
                    if (badge.classList.contains('locked')) {
                        tab.classList.add('locked');
                    } else {
                        tab.classList.remove('locked');
                    }
                }
            });
        }

        // Updated unlock to sync tabs
        function unlockMilestone(id, message) {
            const el = document.getElementById(id);
            if (el && el.classList.contains('locked')) {
                el.classList.remove('locked');
                el.classList.add('unlocked');
                showNotification(`üèÜ Milestone Unlocked: ${message}`, 'success');
                
                syncTabLocks();

                // Automatically show the new content
                const reverseMap = {
                    'm-start': 'intro',
                    'm-crud': 'crud',
                    'm-sql': 'acid',
                    'm-join': 'relational'
                };
                showArticle(reverseMap[id]);
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Set sample query
        function setSampleQuery(query) {
            document.getElementById('sqlQuery').value = query;
            document.getElementById('sqlQuery').focus();
        }
    </script>
</body>
</html>
